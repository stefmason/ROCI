---
title: "Working ROCI analysis"
author: "S. Mason"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 2
    theme: flatly
---

```{r setup, echo=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(QuantPsyc)
library(gridExtra)
knitr::opts_chunk$set(message = FALSE)
```
```{r load data, echo=FALSE}
#Load data
outcomes <- read_excel("~/Documents/ROCIanalysis/ROCI_101918.xlsx", sheet = "Outcomes", range = cell_cols(1:27))
imgs <- read_excel("~/Documents/ROCIanalysis/ROCI_101918.xlsx", sheet = "Imaging", range = cell_cols(1:11))

#RWarngle data
outcomes <- outcomes %>% mutate(non_white = as.factor(ifelse(Race == "White, non-Hispanic origin", 0, 1)), hosp_death = as.factor(ifelse(DC_coded == 0 | DC_coded == 1, 1, 0)), Immsupp = as.factor(Immsupp), Male = as.factor(Male))

imgs <- imgs %>% dplyr::select(-day_3_cxr, -day_5_cxr) %>% filter(admit_cxr == 1) %>% left_join(outcomes, by = "Subject_ID") %>% filter(Final_Dx != "Control") 

#Numerics to factor
imgs$mort28d <- as.factor(imgs$mort28d)
imgs$mort60d <- as.factor(imgs$mort60d)

rm(outcomes)
```

#In-hospital Mortality
##Logistic Regression

```{r logit in-hospital mortality, warning=FALSE}
#In-hospital mortality
hosp_mort <- glm(hosp_death ~ Total+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(hosp_mort)

cbind(OR = exp(coef(hosp_mort)),
      exp(confint(hosp_mort)),
      p = coef(summary(hosp_mort))[,4])
```

```{r in-hosp non-ARDS}
imgs_non <- imgs %>% filter(Final_Dx != "ARDS" & Final_Dx != "Sepsis/ARDS") %>% mutate(quartile = as.factor(ntile(Total,4)))

hosp_mort_non <- glm(hosp_death ~ Total+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs_non)
summary(hosp_mort_non)

cbind(OR = exp(coef(hosp_mort_non)),
      exp(confint(hosp_mort_non)),
      p = coef(summary(hosp_mort_non))[,4])
```


#28-day and 60-day mortality
##Logistic Regression

```{r logit 28d mortality}
one_month <- glm(mort28d ~ Total+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(one_month)

cbind(OR = exp(coef(one_month)),
      exp(confint(one_month)),
      p = coef(summary(one_month))[,4])
```

```{r logit 60d mortality}
two_month <- glm(mort60d ~ Total+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(two_month)

cbind(OR = exp(coef(two_month)),
      exp(confint(two_month)),
      p = coef(summary(two_month))[,4])

imgs %>% filter(mort60d == 1) %>% summarize(count = length(Total))
```

#Overall Mortality
##Cox regression of entire cohort (not in quartiles)

```{r cox proportional hazards}
refdate <- as.Date("2018-09-15")
#Create variables with survival (in days) and a binary indicating censored status
imgs <- mutate(imgs, survival = ifelse(is.na(date_death) == TRUE, as.numeric(difftime(refdate, ICU_admit, units='days')), as.numeric(difftime(date_death, ICU_admit, units='days')))) %>% mutate(censor = ifelse(is.na(date_death) == TRUE, 0, 1))

#Cox regression model
cox_all <- coxph(Surv(survival, censor) ~ Male+Age+non_white+APACHE+Immsupp+Total, data=imgs)
summary(cox_all)
```

```{r test PH assumption}
schoenfeld_res <- cox.zph(cox_all)
plot(schoenfeld_res)
```

##Cox regression of entire cohort by quartile
```{r quartiles}
#create quartiles
imgs <- imgs %>% mutate(quartile = ntile(Total,4)) 
imgs$quartile <- as.factor(imgs$quartile)
```
```{r cox all subjects by quartiles}
#Cox regressions
cox_qt <- survfit(Surv(survival, censor) ~ quartile, data=imgs) #for graph
cox_qt

#cox_quart <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs) #for betas
#summary(cox_quart)
```

```{r pairwise quartile for Cox}
contrasts(imgs$quartile) <- contr.treatment(4, base=4)
cox_qt_base4 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs)
summary(cox_qt_base4)
#Result: Only Q1 is significant

contrasts(imgs$quartile) <- contr.treatment(4, base=3)
cox_qt_base3 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs)
summary(cox_qt_base3)
#Result: Only Q1 is significant

contrasts(imgs$quartile) <- contr.treatment(4, base=2)
cox_qt_base2 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs)
summary(cox_qt_base2)
#Result: Only Q1 is significant

#reset factor to base 1
contrasts(imgs$quartile) <- contr.treatment(4, base=1)
```

```{r Kaplan Meier all subjects}
plot_all <- ggsurvplot(cox_qt, data=imgs, pval=TRUE, pval.size=3,
           ggtheme = theme_minimal(), legend.title="Quartile", legend.labs=c("Q1","Q2","Q3","Q4"),
           risk.table=TRUE, tables.height = 0.2, tables.theme = theme_cleantable(),
           xlim=c(0,3650), break.time.by=365.25, xscale="d_m", ylab="",
           xlab="Months", font.legend=8, title="Entire cohort", font.title=10,
           legend=c(1.1,0.6), risk.table.y.text=FALSE,
           risk.table.fontsize=3, risk.table.title="") 
plot_all$plot <- plot_all$plot + theme(plot.title = element_text(hjust = 0.5))
plot_all
```


##Cox regression for non-ARDS subset
```{r Cox regression for non ARDS}
#non-ARDS patients
imgs_non <- imgs %>% filter(Final_Dx != "ARDS" & Final_Dx != "Sepsis/ARDS") %>% mutate(quartile = as.factor(ntile(Total,4)))

cox_all_non <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs_non) #for betas
summary(cox_all_non)

cox_all_non_strata <- survfit(Surv(survival, censor) ~ quartile, data = imgs_non) #for KM
```
```{r pairwise quartile non ARDS}
contrasts(imgs_non$quartile) <- contr.treatment(4, base=4)
cox_non_base4 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs_non)
summary(cox_non_base4)
#Result: Only Q1 is significant

contrasts(imgs_non$quartile) <- contr.treatment(4, base=3)
cox_non_base3 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs_non)
summary(cox_non_base3)
#Result: Only Q1 is significant

contrasts(imgs_non$quartile) <- contr.treatment(4, base=2)
cox_non_base2 <- coxph(Surv(survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=imgs_non)
summary(cox_non_base2)
#Result: Only Q1 is significant

#reset factor to base 1
contrasts(imgs_non$quartile) <- contr.treatment(4, base=1)
```

```{r KM for non ARDS}
plot_non <- ggsurvplot(cox_all_non_strata, data=imgs_non, pval=TRUE, pval.size=3,
           ggtheme = theme_minimal(), legend.title="Quartile", 
           risk.table=TRUE, tables.height = 0.2, tables.theme = theme_cleantable(),
           xlim=c(0,3650), break.time.by=365.25, xscale="d_m", ylab="",
           xlab="Months", font.legend=8, title="Non-ARDS patients", font.title=10,
           legend="none", risk.table.y.text=FALSE, 
           risk.table.fontsize=3, risk.table.title="") 
plot_non$plot <- plot_non$plot + theme(axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5))
plot_non
```

##KM curves side by side
```{r arrange the plots}
KM_curves <- list()
KM_curves[[1]] <- plot_all
KM_curves[[2]] <- plot_non
arrange_ggsurvplots(KM_curves, print=TRUE, ncol=2, nrow=1)
```

```{r in-hosp mort by quartile}
hosp_mort <- glm(hosp_death ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(hosp_mort)

cbind(OR = exp(coef(hosp_mort)),
      exp(confint(hosp_mort)),
      p = coef(summary(hosp_mort))[,4])
```

```{r pairwise in-hosp quartile evaluation, message=FALSE}
contrasts(imgs$quartile) <- contr.treatment(4, base=2)
inhosp_quart_base2 <- glm(hosp_death ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(inhosp_quart_base2)
#result: Q1is significant, 3 and 4 are not

cbind(OR = exp(coef(inhosp_quart_base2)),
      exp(confint(inhosp_quart_base2)),
      p = coef(summary(inhosp_quart_base2))[,4])

contrasts(imgs$quartile) <- contr.treatment(4, base=3)
inhosp_quart_base3 <- glm(hosp_death ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(inhosp_quart_base3)
#result: Q1 is significant, 2 and 4 are not

cbind(OR = exp(coef(inhosp_quart_base3)),
      exp(confint(inhosp_quart_base3)),
      p = coef(summary(inhosp_quart_base3))[,4])

contrasts(imgs$quartile) <- contr.treatment(4, base=4)
inhosp_quart_base4 <- glm(hosp_death ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=imgs)
summary(inhosp_quart_base4)
#result: Q1 is significant, 2 and 3 are not

cbind(OR = exp(coef(inhosp_quart_base4)),
      exp(confint(inhosp_quart_base4)),
      p = coef(summary(inhosp_quart_base4))[,4])

#reset factor to base 1
contrasts(imgs$quartile) <- contr.treatment(4, base=1)
```

##ICU Length of stay
```{r ICU LOS, warning=FALSE}
contrasts(imgs$quartile) <-contr.treatment(4,base = 1)

#Negative binomial model
ICUdays_nb <- glm.nb(ICU_days ~ Total+APACHE+Age+non_white+Male+Immsupp, data=imgs)
summary(ICUdays_nb)
cbind(IRR = exp(coef(ICUdays_nb)), exp(confint(ICUdays_nb)))[2,]

#ICUdays_nbq <- glm.nb(ICU_days ~ quartile+APACHE+Age+non_white+Male+Immsupp, data=imgs)
#summary(ICUdays_nbq)
#cbind(IRR = exp(coef(ICUdays_nbq)), exp(confint(ICUdays_nbq)))[2:4,]
```

##Duration of mechanical ventilation
```{r mechanical ventilation, warning=FALSE}

#Negative binomial model - all patients
#MVdays_nb <- glm.nb(days_MV ~ Total+APACHE+Age+non_white+Male+Immsupp, data=imgs)
#summary(MVdays_nb)
#cbind(IRR = exp(coef(MVdays_nb)), exp(confint(MVdays_nb)))[2,]

#only intubated patients
intub <- imgs %>% filter(days_MV != 0)
MVdays_nb2 <- glm.nb(days_MV ~ Total+APACHE+Age+non_white+Male+Immsupp, data=intub)
summary(MVdays_nb2)
cbind(IRR = exp(coef(MVdays_nb2)), exp(confint(MVdays_nb2)))[2,]

#MVdays_nbq <- glm.nb(days_MV ~ quartile+APACHE+Age+non_white+Male+Immsupp, data=imgs)
#summary(MVdays_nbq)
#cbind(IRR = exp(coef(MVdays_nbq)), exp(confint(MVdays_nbq)))[2:4,]
```

```{r IRR to absolute days}
#ICU days (mean x IRR)
incr_days = exp(coef(ICUdays_nb)) * mean(imgs$ICU_days)
incr_days
mean(imgs$ICU_days)

#Days MV
more_days = exp(coef(MVdays_nb2)) * mean(intub$days_MV)
more_days
mean(intub$days_MV)
```


```{r boxplot data prep}
library(reshape2)
library(RColorBrewer)
#Eliminate non-intubated from the MV data and transform for plotting
meltICU <- imgs %>% dplyr::select(Subject_ID, ICU_days, quartile) %>% melt(id.vars="quartile", measure.vars="ICU_days")
meltMV <- imgs %>% filter(days_MV != 0) %>% dplyr::select(Subject_ID, days_MV, quartile) %>% melt(id.vars="quartile", measure.vars="days_MV")
meltplot <- rbind(meltICU, meltMV)
```
```{r boxplot: square root}
#Generate the boxplot
ggplot(meltplot) + geom_boxplot(aes(quartile, sqrt(value), color=variable)) +   
  scale_x_discrete(name="Chest Radiograph Score Quartile") + 
  scale_y_continuous(name="(Square root of) Days") +
  theme_minimal() + theme(plot.title = element_text(face = "bold")) +
  theme(panel.grid.minor = element_blank()) + 
  theme(legend.title = element_blank()) +
  

```


```{r zero-inflated negative binomial, warning=FALSE}
#good for count data with lots of zeros (eg duration of MV)
#library(pscl)
#library(MASS)
#library(boot)

#look at the data - we see that zero is over-represented and the data are highly non-normal (bad for OLS) with a wide dispersion (bad for zero-inflated Poisson).
#ggplot(aes(days_MV), data=imgs) + geom_histogram(binwidth = 2)

#zinb <- zeroinfl(days_MV ~ Total | non_white+Male+APACHE+Immsupp, data=imgs, dist="negbin", EM=TRUE)
#summary(zinb)
```

##Miscellaneous
```{r survival stats}
shapiro.test(imgs$survival)

imgs %>% summarize(mean = mean(survival), median = median(survival), min = min(survival), max = max(survival), count = length(survival))

imgs %>% mutate(surv_quart = ntile(survival, 4)) %>% group_by(surv_quart) %>% summarize(mean = mean(survival), median = median(survival), min = min(survival), max = max(survival), count = length(survival))
```

```{r case mix}
imgs %>% group_by(Final_Dx) %>% summarize(count = length(Total))
```

```{r histogram of CXR scores}
imgs %>% ggplot(aes(Total, color = quartile, fill = quartile)) + geom_histogram(bins = 15)
```



