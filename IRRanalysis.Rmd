---
title: "IRR"
author: "S. Mason"
date: "10/3/2018"
output: html_document
---
```{r set-up, message=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(irr)
library(psych)
library(gridExtra)
```
```{r import IRR data, message=FALSE}
#import the Excel sheet with the IRR data
ratings <- read_excel("~/Documents/ROCIanalysis/ROCI_101918.xlsx", sheet = "IRR_2", range = cell_cols(1:10))

ratings <- ratings %>% dplyr::select(Subject_ID, Reviewer, Total) %>% spread(Reviewer, Total)
colnames(ratings) <- c("Subject_ID", "Total", "score")

```

```{r add Sam's data}
sam_irr <- read_excel("~/Documents/ROCIanalysis/ROCI_sam.xlsx", sheet = "Imaging", range = cell_cols(1:16))
sam_irr <- sam_irr %>% dplyr::select(Subject_ID, Total, total_sa)
colnames(sam_irr) <- c("Subject_ID", "Total", "score")

ratings <- rbind(sam_irr, ratings)
```

Calculating an ICC (two-way, consistency, with 95% confidence):
```{r ICC with IRR package}
irr::icc(ratings[c(2,3)], model="t", type="c", unit="s", r0=0, conf.level=0.95)
```
```{r ICC w psych package}
psych::ICC(ratings[c(2,3)], missing=TRUE, alpha=0.05)
```

<br>And a Cohen's kappa (with squared weights):
```{r kappa}
kappa2(ratings[c(2,3)], "squared")
#doesn't kappa assume nominal data??
```
<br>Scatterplot of agreement:
```{r scatterplot}
scatter <-ggplot(ratings, aes(Total, score)) + geom_jitter(size=2) + ggtitle("A") + xlab("Reviewer 1 score") + ylab("Reviewer 2 score")
scatter_lines <- scatter + geom_abline(slope=1, size=0.5, color="blue") + scale_x_continuous(breaks=seq(0,16,2)) + scale_y_continuous(breaks=seq(0,16,2)) +
  theme_minimal()
scatter_lines
```
<br>A Bland-Altman plot:
```{r BA plot}
#Generate the differences and averages for plot
ratings <- mutate(ratings, diff = (Total - score), avg = ((Total + score) / 2))
#Generate plot
BAplot <- ggplot(ratings, aes(avg, diff)) + geom_jitter(size=2) + ggtitle("B") + xlab("Average") + ylab("Difference")
BAplot_lines <- BAplot + geom_hline(yintercept=mean(ratings$diff), color="blue", size=0.5) + geom_hline(yintercept=mean(ratings$diff) - 1.96*sd(ratings$diff), color="red", size=0.5) + geom_hline(yintercept=mean(ratings$diff) + 1.96*sd(ratings$diff), color="red", size=0.5) + theme_minimal()
BAplot_lines
```

```{r plots side by side}
grid.arrange(scatter_lines, BAplot_lines, ncol=2)
```



## Isolating CXR read by Stefanie
```{r xrays for Sam}
temp_data <- read_excel("~/Documents/ROCIanalysis/ROCI_temp.xlsx", sheet = "Img_edit") #previously scored
temp_imgs <- read_excel("~/Documents/ROCIanalysis/ROCI_101918.xlsx", sheet = "Imaging", range = cell_cols(1:11)) #final group
```
```{r}
subjects <- imgs$Subject_ID
temp_data <- temp_data %>% filter(Subject_ID %in% subjects)
temp_imgs <- temp_imgs %>% dplyr::select(-day_3_cxr, -day_5_cxr) %>% filter(admit_cxr == 1) %>% filter(Subject_ID %in% subjects)
```
```{r}
temp_merged <- merge(x=temp_data, y=temp_imgs, by.x=c("Subject_ID", "CXRdate"), by.y=c("Subject_ID", "cxr_date"))
```
```{r}
temp_merged %>% filter(Total.x != Total.y)
```

```{r}
write.csv(temp_merged, file="Temp_merged.csv", row.names=FALSE)
```



