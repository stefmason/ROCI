---
title: "CXR scores and clinical outcomes"
author: "Stefanie Mason"
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
---
```{r setup, echo=FALSE, message=FALSE}
library(readxl)
library(tidyverse)
library(survival)
library(survminer)
library(QuantPsyc)
library(gridExtra)
library(irr)
library(reshape2)
library(RColorBrewer)
library(olsrr)
library(broom)
library(data.table)
```


## Inter-rater reliability
```{r import IRR file}
IRR <- read_excel("ROCI_clean.xlsx", sheet = "IRR")
#Reorganise data from rows into columns
IRR <- IRR %>% dplyr::select(-Subject_ID, -Quad1, -Quad2, -Quad3, -Quad4) %>% unite(img_date, CXR_date, CXR_time, sep="_") %>% spread(Reviewer, Total) 
names(IRR) <- c("img_id", "Rev1", "Rev2")
```

<p>Calculation of a two-way, mixed consistency single-measures intraclass correlation coefficient:
```{r ICC calculation}
icc(IRR[c(2,3)], model="t", type="c", r0=0, conf.level=0.95)
```

<p>Our coefficient demonstrates good agreement between raters. Let's look at this visually with a simple scatterplot as well as a Bland-Altman plot.

```{r scatterplot}
scatter <- ggplot(IRR, aes(Rev1, Rev2)) + geom_point(size=2) + 
  ggtitle("A") + xlab("Reviewer 1 score") + ylab("Reviewer 2 score") + 
  geom_abline(slope=1, size=0.5, color="blue") + 
  scale_x_continuous(breaks=seq(0,16,2)) + scale_y_continuous(breaks=seq(0,16,2))
```

```{r BA plot}
#Generate the differences and averages for plot
IRR <- mutate(IRR, diff = (Rev1 - Rev2), avg = ((Rev1 + Rev2) / 2))
#Generate plot
BAplot <- ggplot(IRR, aes(avg, diff)) + geom_point(size=2) + 
  ggtitle("B") + xlab("Average") + ylab("Difference") +
  geom_hline(yintercept=mean(IRR$diff), color="blue", size=0.5) + 
  geom_hline(yintercept=mean(IRR$diff) - 1.96*sd(IRR$diff), color="red", size=0.5) + 
  geom_hline(yintercept=mean(IRR$diff) + 1.96*sd(IRR$diff), color="red", size=0.5)
```

```{r plot together}
grid.arrange(scatter, BAplot, ncol=2)
```

## Mortality

```{r import regression data, message=FALSE}
#Load data
outcomes <- read_excel("ROCI_clean.xlsx", sheet = "Outcomes", range = cell_cols(1:17))
images <- read_excel("ROCI_clean.xlsx", sheet = "Imaging", range = cell_cols(1:9))

#RWarngle data
outcomes <- outcomes %>% mutate(non_white = as.factor(ifelse(Race == "White, non-Hispanic origin", 0, 1)), hosp_mort = as.factor(ifelse(DC_coded == 0 | DC_coded == 1, 1, 0)), Immsupp = as.factor(Immsupp), Male = as.factor(Male))

images <- images %>% dplyr::select(-day_3_cxr, -day_5_cxr) %>% filter(admit_cxr == 1) %>% left_join(outcomes, by = "Subject_ID") %>% filter(Final_Dx != "Control") 

#This results in a data frame with 560 observations, which is what we expect
```

### In-hospital mortality
For in-hospital mortality, our outcome is a binary state: you survived to discharge or you did not. This suggests we should use a logistic regression. It is common in the ICU literature to control for age, race, and gender. I will also control for immunosuppression and their illness severity (as calculated by the APACHE score).

```{r logit in-hospital mortality, message=FALSE}
#In-hospital mortality
inhosp <- glm(hosp_mort ~ Total+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=images)
summary(inhosp)

cbind(OR = exp(coef(inhosp)),
      exp(confint(inhosp)),
      p = coef(summary(inhosp))[,4])
```

<p> This data indicates that the CXR score (variable = Total) is a significant predictor of in-hospital death. It suggests that for every 1-point increase in total CXR score, there is a 9.47% increased risk of death (CI: 4.34-15.0).

<p> But a previous paper by Warren et. al. suggested noted a significant difference between quartiles 1&2 compared to 3&4. This suggests there may be a threshold effect to survival. So is the CXR score equally predictive across quartiles? 

<p> First, let's take a quick look at what range of CXR scores fall in each quartile.
```{r quartile}
#Make quartiles
images <- images %>% mutate(quartile = as.factor(ntile(Total,4)))

#Summarize quartiles
images %>% group_by(quartile) %>% summarise(min_score = min(Total), max_score = max(Total), median = median(Total), n = length(Total))
```

<p>Now, let's re-run the regression with quartiles. 
```{r logit by quartile, message=FALSE}
#Re-run regression
inhosp_quart <- glm(hosp_mort ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=images)
summary(inhosp_quart)

cbind(OR = exp(coef(inhosp_quart)),
      exp(confint(inhosp_quart)),
      p = coef(summary(inhosp_quart))[,4])
```

```{r pairwise quartile evaluation}
contrasts(images$quartile) <- contr.treatment(4, base=2)
inhosp_quart_base2 <- glm(hosp_mort ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=images)
summary(inhosp_quart_base2)
#result: Q1is significant, 3 and 4 are not

contrasts(images$quartile) <- contr.treatment(4, base=3)
inhosp_quart_base3 <- glm(hosp_mort ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=images)
summary(inhosp_quart_base3)
#result: Q1 is significant, 2 and 4 are not

contrasts(images$quartile) <- contr.treatment(4, base=4)
inhosp_quart_base4 <- glm(hosp_mort ~ quartile+Male+Age+Immsupp+APACHE+non_white, family=binomial(link='logit'), data=images)
summary(inhosp_quart_base4)
#result: Q1 is significant, 2 and 3 are not

#reset factor to base 1
contrasts(images$quartile) <- contr.treatment(4, base=1)
```


```{r jitterplot}
images %>% ggplot(aes(quartile, Total, color=hosp_mort)) + geom_jitter(width=0.25) + 
  scale_color_manual(values=c("#000000", "#990033"), name="", labels=c("Lived", "Died")) +
  xlab("Score quartile") + ylab("Total CXR score") + ggtitle("In hospital death by CXR score quartile")
```

<p> The result is significant across all quartiles (with lower scores = quartile 1 being the reference group) with increasing OR for each successive quartiles. Similar to the previous paper, however, the difference between quartiles 3 and 4 is not large. The second quartile has 2.7 times the odds of in-hospital death, the third quartile 3.3 times the odds, and the highest quartile has 3.5 times the odds of in-hospital death compared with the lowest quartile. 

### Overall mortality
So now that we know the CXR score predicts in-hospital mortality, does it also predict overall mortality? For this, I will use a cox regression. Again, to better explore the nature of the association, this is done in quartiles. The result will be visualized with a Kaplan Meier curve.

```{r cox proportional hazards}
#Cox regression model
cox_quart <- coxph(Surv(Survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+strata(quartile), data=images) #for KM
cox_qt <- coxph(Surv(Survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+Total, data=images) #for HR
summary(cox_qt)
```

```{r pairwise quartile for Cox}
contrasts(images$quartile) <- contr.treatment(4, base=4)
cox_qt_base4 <- coxph(Surv(Survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=images)
summary(cox_qt_base4)
#Result: Only Q1 is significant

contrasts(images$quartile) <- contr.treatment(4, base=3)
cox_qt_base3 <- coxph(Surv(Survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=images)
summary(cox_qt_base3)
#Result: Only Q1 is significant

contrasts(images$quartile) <- contr.treatment(4, base=2)
cox_qt_base2 <- coxph(Surv(Survival, censor) ~ Age+Male+Immsupp+non_white+APACHE+quartile, data=images)
summary(cox_qt_base2)
#Result: Only Q1 is significant

#reset factor to base 1
contrasts(images$quartile) <- contr.treatment(4, base=1)
```

```{r Kaplan Meier all subjects}
KM_all <- ggsurvplot(survfit(cox_quart), data=images, 
           ggtheme = theme_minimal(), legend.title="Quartile", legend.labs=c("Q1","Q2","Q3","Q4"),
           risk.table=TRUE, tables.height = 0.2, tables.theme = theme_cleantable(),
           xlim=c(0,3650), break.time.by=365.25, xscale="d_m", ylab="",
           xlab="Months", font.legend=8, title="Survival by CXR score quartile", font.title=10,
           legend=c(1.1,0.6), risk.table.y.text=FALSE,
           risk.table.fontsize=3, risk.table.title="") 
KM_all$plot <- KM_all$plot + theme(plot.title = element_text(hjust = 0.5))
KM_all
```

<p> The overall survival data suggests more of a threshold effect than the in-hospital death data did. The hazard ratios for each quartile are significant, but are fairly similar for quartiles 2, 3, and 4 compared to the lowest quartile. This is most striking when looking at the KM plot: the quartile 1 curve (orange) is clearly separated from the other three. 

<p>Could all of this be driven by the subset of patients in this cohort with acute respiratory distress syndrome (ARDS)? In other words, does the relationship remain true when we remove the sickest respiratory patients and instead look mostly at people with blood infections/inflammation (what we call sepsis)? To find out, let's re-run the Cox and re-draw the KM without the ARDS patients (n=122).

```{r Cox regression for non ARDS}
#non-ARDS patients
imgs_non <- images %>% filter(Final_Dx != "ARDS" & Final_Dx != "Sepsis/ARDS") %>% mutate(quartile = as.factor(ntile(Total,4)))
cox_non <- coxph(Surv(Survival, censor) ~ Male+Age+non_white+APACHE+Immsupp+strata(quartile), data=imgs_non)  #for KM
cox_non_hr <- coxph(Surv(Survival, censor) ~ Male+Age+non_white+APACHE+Immsupp+quartile, data=imgs_non) 
summary(cox_non_hr)
```

```{r KM for non ARDS}
KM_non <- ggsurvplot(survfit(cox_non), data=imgs_non, 
           ggtheme = theme_minimal(), legend.title="Quartile", 
           risk.table=TRUE, tables.height = 0.2, tables.theme = theme_cleantable(),
           xlim=c(0,3650), break.time.by=365.25, xscale="d_m", ylab="",
           xlab="Months", font.legend=8, title="Survival by CXR score quartile in non-ARDS patients", font.title=10,
           legend="none", risk.table.y.text=FALSE, 
           risk.table.fontsize=3, risk.table.title="") 
KM_non$plot <- KM_non$plot + theme(axis.text.y = element_blank(), plot.title = element_text(hjust = 0.5))
KM_non
```

<p> The relationship between the CXR score and survivial is essentially identical despite the removal of the ARDS patients. Again we see a threshold effect between the lowest quartile and the upper three. What is of particular interest about this threshold, is that it is quite low. Recall the quartile ranges described above. The lowest quartile were scores from 0-2. This suggests that even a mild abnormality on the CXR has significant implications for prognosis in ICU patients. The previously mentioned Warren et al paper also demonstrated an association between CXR score and survival, however their association was no longer significant when controlling for APACHE score. It is possible that given their cohort was entirely made of ARDS patients, all of their subjects fell above quartile 1 and thus they were unable to discern this very low threshold effect. 

## Other Outcome Measures
### Length of ICU stay

<p>Let's turn away from mortality and look at some other clinical measures such as length of stay in the ICU and duration of mechanical ventilation.

```{r ICU LOS, warning=FALSE, message=FALSE}
contrasts(images$quartile) <-contr.treatment(4,base = 1)

#Negative binomial model
ICUdays_nb <- glm.nb(ICU_days ~ Total+APACHE+Age+non_white+Male+Immsupp, data=images)
summary(ICUdays_nb)
cbind(IRR = exp(coef(ICUdays_nb)), exp(confint(ICUdays_nb)))[2,]
```

```{r mechanical ventilation, warning=FALSE, message=FALSE}
#Negative binomial: intub patients only
intub <- images %>% filter(days_MV != 0)
MVdays_nb <- glm.nb(days_MV ~ Total+APACHE+Age+non_white+Male+Immsupp, data=intub)
summary(MVdays_nb)
cbind(IRR = exp(coef(MVdays_nb)), exp(confint(MVdays_nb)))[2,]
```

```{r boxplot}
#Eliminate non-intubated from the MV data and transform for plotting
meltICU <- images %>% dplyr::select(Subject_ID, ICU_days, quartile) %>% melt(id.vars="quartile", measure.vars="ICU_days")
meltMV <- intub %>% dplyr::select(Subject_ID, days_MV, quartile) %>% melt(id.vars="quartile", measure.vars="days_MV")
meltplot <- rbind(meltICU, meltMV)

#Generate the boxplot
ggplot(meltplot) + geom_boxplot(aes(quartile, value, color=variable)) +   
  scale_x_discrete(name="CXR Score Quartile") + 
  scale_y_sqrt(name="Days", breaks=c(0,4,9,16,25,36,49,64,81)) +
  ggtitle("Duration of Mechanical Ventilation & ICU Length of Stay") +
  theme_minimal() + theme(plot.title = element_text(face = "bold")) +
  theme(panel.grid.minor = element_blank()) + 
  guides(color=guide_legend(title = "Outcome"))

```

<p> These data demonstrate that for each one point increase in CXR score, ICU length of stay increased by 5.72% (Rate ratio 1.06, CI 1.04-1.07). For each one point increase in CXR, the duration of mechanical ventilation (for intubated patients) increased 4.44% (rate ratio 1.04, CI 1.02-1.07). 

## Lung weights

<p>To ensure the CXR score is measuring a physiologic state rather than an artifact of imaging, the CXR scores were compared to lung weights measured at autopsy. For the patients in the cohort whom died in the hospital and their family consented to autopsy, the last CXR prior to death (must be within 24 hours) was scored. Since each lung is weighted seperately the weight of the right lung was compared to the sum of quartiles 1&3 (the right sided quartiles) and the weight of the left lung was compared to the sum of quartiles 2&4 (the left sided quartiles). 

```{r load lung weight data}
#Load imaging/weight data and merge
weights <- read_excel("ROCI_clean.xlsx", sheet = "LungWt", range = cell_cols(1:10)) %>% 
  gather(side, weight, r_lung_wt:l_lung_wt) %>%
  mutate(side = ifelse(side == "r_lung_wt", "right", "left"), side_total = ifelse(side == "right", quad1+quad3, quad2+quad4)) %>%
  filter(wi_24h == 1) 

weights <- outcomes %>% dplyr::select(Subject_ID, Male) %>% right_join(weights, by="Subject_ID")
```

### Normality
<p>Shapiro Wilk testing was used to test the normality of the distribution of lung weights to be analysed. The distribution was visually inspected with a histrogram.

```{r normality test, warning=FALSE}
shapiro.test(weights$weight)
weights %>% ggplot(aes(weight)) + geom_histogram(bins = 25)
```

<p>The data are non-normally distributed. Warren et al correlated their CXR score with lung weights at explant in lung transplant donors. They used a Spearman correlation. However, this would not allow me to correct for height, which is an important predictor of lung size. Since I want to account for height, I will instead use a linear regression (continuous predictor of a continuous outcome). I will plan to assess the normality of residuals to be sure the model is appropriate. 

```{r linear regression, warning=FALSE}
weights %>% ggplot(aes(side_total, weight)) + geom_point() + geom_smooth(method = "lm") + xlab("CXR score") +
  ylab("Weight (g)") + ggtitle("CXR score as a predictor of lung weight at autopsy")

wt <- lm(weight ~ side_total+height+Male, data = weights)
summary(wt)
```

<p>Even accounting for height and gender, the CXR score is a significant predictor of lung weight at autopsy. The supports the concept that the opacities seen (and scored) on the CXR correlate to a physiologic process (evident at autopsy).

<p> Since the data were non-normal, let's check a QQ plot and see if the residuals are normally distributed.

```{r qq plot}
#check normality of errors
ols_plot_resid_qq(wt)
ols_test_correlation(wt)  #expected vs predicted residuals
```

<p>The residual testing suggests a linear regression model was reasonable despite the non-normality of the input data.

## Biomarkers

<p>Researchers have long been looking for something they can measure in blood work that will predict clinical outcomes. No single measure has proven definitive, which is one reason the scoring systems use so many different measures. For example, procalcitonin is a marker of bacterial infection, but it is not elevated in viral or fungal disease (or non-infectious disease). In contrast, mitchondrial DNA (mtDNA) has been associated with in-ICU death and, in patients with levels >3,200, with overall survival time, regardless of underlying diagnosis. One of the drawbacks is that the association does not hold in cardiac ICU or neurologic ICU patients. But this dataset is medical ICU patients, so I would expect the CXR score to be associated with mtDNA levels.

```{r import biomarker data}
#Biomarker data
biomarker <- read_excel("ROCI_clean.xlsx", sheet="markers", range = cell_cols(1:9))
biomarker <- biomarker %>% dplyr::select(-UO_24) %>% rename(Subject_ID = SID) 
biomarker <- images %>% dplyr::select(Subject_ID, Total, APACHE) %>% right_join(biomarker, by="Subject_ID")
```

###Data summary

<p>Let's take a look at how much biomarker data exists and it looks like.

```{r summary stats}
#This isn't the most efficient way of accomplishing this, but I wanted to demonstrate functions and apply()
markers <- biomarker %>% dplyr::select(IL18D0, nadh_copies, HMITO_38, HMITO_96, bglob, Lactate)

#define functions to accomodate missing data
count_rows <- function(x){
  NROW(na.omit(x))
}
max_val <- function(x){
  max(na.omit(x))
}
min_val <- function(x){
  min(na.omit(x))
}

#Build the summary table
sum_stat <- data.table(IL18D0=double(), nadh_copies=double(), HMITO_38=double(), HMITO_96=double(), bglob=double(), Lactate=double())
sum_stat <- rbind(sum_stat, t(apply(markers, 2, count_rows)))
sum_stat <- rbind(sum_stat, t(apply(markers, 2, max_val)))
sum_stat <- rbind(sum_stat, t(apply(markers, 2, min_val)))
sum_stat <- cbind(sum_stat, c("n", "max", "min"))
sum_stat <- sum_stat[,c(7,1,2,3,4,5,6)]
sum_stat
```

```{r biomarker scatterplot, warning=FALSE}
biomarker %>% dplyr::select(IL18D0, nadh_copies, HMITO_38, HMITO_96, bglob, Lactate, Total) %>% gather(marker, value, -Total, na.rm=T) %>% 
  ggplot(aes(Total, value)) + geom_point() + scale_y_log10() + facet_grid(.~marker) + ylab("value (log scale)") + xlab("Total CXR score")
```

<p>Truthfully, I am not going to use all these biomarkers. The literature is strongest for IL-18 (inflammatory marker), nadh (which represents mitchondrial DNA), and bglob (which is nuclear DNA). So going forward, those are the ones I will work with.

###Normality
<p>Some of those distributions do not look normal. Let's check them with the Shapiro-Wilk test and then see if transformations would help.

```{r normality}
#Original scale
shapiro.test(biomarker$IL18D0)
shapiro.test(biomarker$nadh_copies)
shapiro.test(biomarker$bglob)

#Log transforms
biomarker <- biomarker %>% mutate(logIL18 = log10(IL18D0), logbglob = log10(bglob), lognadh = log10(nadh_copies))

shapiro.test(biomarker$logIL18)
shapiro.test(biomarker$lognadh)
shapiro.test(biomarker$logbglob)
```

<p>NADH and IL-18 log transform to normal. Bglob does not, but it's closer. 

###Univariable model

<p>Let's see if the CXR score predicts the blood level of the biomarker.

```{r univariate regression}
biomarker %>% dplyr::select(logIL18, lognadh, logbglob, Total) %>% gather(marker, value, -Total, na.rm=T) %>%
  group_by(marker) %>% do(tidy(lm(value~Total, data = .))) %>% filter(term != "(Intercept)")

```

```{r scatterplot with log transforms, warning=FALSE}
biomarker %>% dplyr::select(lognadh, logbglob, Total) %>% gather(marker, value, -Total, na.rm=T) %>% 
  ggplot(aes(Total, value)) + geom_point() + facet_grid(.~marker) + ylab("value (log scale)") + xlab("Total CXR score") + geom_smooth(method = "lm")
```

<p>In an unadjusted analysis, the CXR score is significantly associated with mtDNA, nucDNA, but not the IL-18 inflammatory marker. What happens when I control for APACHE score?

###Multivariable model

```{r multivariate regression}
biomarker %>% dplyr::select(logIL18, lognadh, logbglob, Total, APACHE) %>% gather(marker, value, -Total, -APACHE, na.rm=T) %>%
  group_by(marker) %>% do(tidy(lm(value~Total+APACHE, data = .))) %>% filter(term != "(Intercept)")
```

<p>Unfortunately the associations are no longer significant once I control for the APACHE score. While it would be ideal if the association held, the biomarkers themselves are not perfect proxies for survival. 

```{r follow up stats}
images %>% mutate(surv_quart = ntile(Survival, 4)) %>% group_by(surv_quart) %>% summarise(mean = mean(Survival), median = median(Survival), min = min(Survival), max = max(Survival), count = length(Survival))
```


